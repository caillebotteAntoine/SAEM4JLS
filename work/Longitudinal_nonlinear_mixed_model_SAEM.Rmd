---
title: "Test NLME SEAM"
author: "Antoine caillebotte"
date: "`r Sys.time()`"
output: html_document
---
  
<style type="text/css">
.main-container {
  max-width: 1000px;
  margin-left: auto;
  margin-right: auto;
}
</style>
  
```{r setup, include = F}
library(knitr)
library(kableExtra)

rm(list = ls())

opts_chunk$set(echo = T, message = F, warning = F,
               fig.weightedidth = 12,
               fig.asp = 0.8,
               out.weightedidth = "100%")

require(SAEM4JLS)
```

## Initialisation

```{r init}
m <- function(t, eta, phi) (phi[1] + eta)/(1+exp((phi[2]-t)/phi[3]))

#=======================================#
param <- list(rho2 = 0.1,
              sigma2 = 0.05,
              mu = c(5,4,0.5),
              omega2 = c(0.5,0.1,0.01))

F. <- length(param$omega2) #dimension de phi
#=======================================#

t <- seq(2,6, length.out = 10) #valeur des temps

G <- 40
ng = 4
n <- G*ng*length(t) #nombre total de data
N <- G*ng #nombre total d'individu


dt <- NLME_obs(G, ng, t, param, m)
Y <- dt$obs

dt %>% ggplot(aes(t, obs, col = gen, group = id)) + 
  geom_point() + geom_line() + 
  theme(legend.position = 'null')
```

## SAEM avec simulation par MCMC
$$\log f(Y, Z ; \theta) = \langle \Phi(\theta) ; S(Y,Z) \rangle - \psi(\theta)$$

```{r setup stat exhaustive}
Phi <- function(rho2, sigma2, mu, omega2)
  c(- n/(2*sigma2), -N/(2*rho2), -G/(2*omega2), G*mu/omega2)

S <- function(eta, phi)
{
  s <- c(mean((Y - get_obs(m, dt, eta = eta, phi = phi) )^2 ), #id = 1
         mean(eta^2),                    #id = 2
         apply(phi^2, 2, mean),          #id = 3
         apply(phi  , 2, mean) )         #id = 4

  attr(s, '1') <- 1
  attr(s, '2') <- 2
  attr(s, '3') <- 2 + 1:ncol(phi)
  attr(s, '4') <- 2 +   ncol(phi) + 1:ncol(phi)
  return(s)
}
```
## Metropolis Hastings

```{r MH}
#=============================================================================#
loglik.phi <- function(x, eta, Phi)
{
  s <- S(eta,x)
  
  id <- c(attr(s,'1'), attr(s,'3'), attr(s,'4')) #indice de S_1 et S_{3,.} puis S_{4,.}
  sum(Phi[id]*s[id])
}
loglik.eta <- function(x, phi, Phi) 
{ 
  s <- S(x, phi)
  id <- c(attr(s,'1'), attr(s,'2'))
  sum(Phi[id]*s[id])
}
```

```{r MH phi, eval=FALSE}
phi.MH <- matrix(rnorm(F.*G, c(6,3,1), 0.1), nrow = F.) %>% t
phi.MH <- MH_High_Dim_para(100, phi.MH, sd = c(.03, .02, .01), loglik.phi, attr(dt, 'eta'), do.call(Phi, param),
                           verbatim = T, cores = future::availableCores()-2)
plot(phi.MH, dim = G)
```

```{r MH eta, eval=FALSE}
eta.MH <- MH_High_Dim_para(100, matrix(rnorm(N, 0, 0.5), nrow = 1), sd = .02, loglik.eta,  attr(dt, 'phi'), do.call(Phi, param),
                           verbatim = T, cores = future::availableCores()-2)
plot(eta.MH)
```

# SAEM
### initialisation
```{r SAEM init}
# --- Nombre iteration --- #
M <- 1
u <- function(k) ifelse(k<200, 1, 1/(k-199) )

# ---  Initialisation des paramÃ¨tres --- #

para <- list( rho2 = 0.5,
              sigma2 = 0.1,
              mu = rep(1, F.),
              omega2 = rep(0.3, F.) )

para <- param %>% sapply(function(x) x + runif(1))


# --- Initialisation des chaines MC : Z_0 --- #
etagivenY <- 1:M %>% lapply(function(i) rnorm(N, 0,0.2)  %>% matrix(ncol = 1) )
phigivenY <- 1:M %>% lapply(function(i) matrix(rnorm(F.*G, c(6,3,1), 0.1), nrow = F.) %>% t  )
```

## Boucle

```{r SAEM}
sim <- function(niter, Phih, etagivenY, phigivenY)
{
  M <- length(phigivenY)
  etagivenY <- 1:M %>% lapply( function(i)
    MH_High_Dim_para(niter, etagivenY[[i]], sd = .02,loglik.eta, phigivenY[[i]], Phih,
                     cores = future::availableCores()-2) )

  phigivenY <- 1:M %>% lapply( function(i)
    MH_High_Dim_para(niter, phigivenY[[i]], sd = c(.03, .02, .01), loglik.phi, etagivenY[[i]], Phih,
                     cores = future::availableCores()-2) )

  list(eta = etagivenY, phi = phigivenY)
}


maxi <- function(S)
{
  list(rho2 =   S[attr(S,'2')],
       sigma2 = S[attr(S,'1')],
       mu =     S[attr(S,'4')],
       omega2 = S[attr(S,'3')] - S[attr(S,'4')]^2 )
}

maxi(S(attr(dt, 'eta'), attr(dt, 'phi')))

niter <- 200
MH.iter <- 10
Z <- list(eta = etagivenY, phi = phigivenY)
res <- SAEM(niter, MH.iter, u, para, Phi, S, Z, sim, maxi, eps = 51e-1, verbatim = T)

plot(res)
plot(res$Z$phi[[1]], dim = G)
plot(res$Z$eta[[1]], dim = G)
```










