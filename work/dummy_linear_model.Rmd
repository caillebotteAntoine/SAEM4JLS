---
title: "SAEM 4 dummy linear model"
author: "Antoine caillebotte"
date: "`r Sys.time()`"
output: html_document
---
  
<style type="text/css">
.main-container {
  max-width: 1000px;
  margin-left: auto;
  margin-right: auto;
}
</style>
  
```{r setup, include = F}
library(knitr)
library(kableExtra)

rm(list = ls())

opts_chunk$set(echo = T, message = F, warning = F,
               fig.weightedidth = 12,
               fig.asp = 0.8,
               out.weightedidth = "100%")

require(SAEM4JLS)
```

## Initialisation

```{r init data}
m <- function(t, eta, phi) phi[1] * t

ng <- 1 #nombre d'individu par groupe
G <- 40 # nombre groupe
#===============================#
param <- list( sigma2 = 0.5,  #variance de l'erreur
               mu = 3,  #moyenne de phi
               omega2 = 0.1 )  #variance de phi

F. <- length(param$omega2) #dimension de phi
#===============================#
t <- seq(-5,5, length.out = 10) #valeur des temps

dt <- NLME_obs(G, ng, t, param, m)
Y <- dt$obs

n <- nrow(dt) #nombre total de data
N <- G*ng #nombre total d'individu

#================================= Affichage ================================#
dt %>% ggplot(aes(t, obs, col = gen, group = id)) + 
  geom_point() + geom_line() + theme(legend.position = 'null')
```


```{r MH}
Phi <- function(sigma2, mu, omega2)
  c(- 1/(2*sigma2), -1/(2*omega2), mu/omega2)

S <- function(phi)
{
  s <- c(sum((Y - get_obs(m, dt, phi = phi))^2 ),
    apply(phi^2, 2, sum),
    apply(phi  , 2, sum) )

  attr(s, '1') <- 1
  attr(s, '2') <- 1 + 1:ncol(phi)
  attr(s, '3') <- 1 + ncol(phi) + 1:ncol(phi)
  return(s)
}
#=============================================================================#
loglik.phi <- function(phi, Phi)
{
  s <- S(phi)
  sum(s*Phi)
}

phi.MH <- MH_High_Dim_para(1000, matrix(rnorm(F.*G, 0,1), ncol = F.), sd = .05, loglik.phi, do.call(Phi, param), 
                           verbatim = T, cores = future::availableCores()-2)
plot(phi.MH, dim = G)
```

```{r SAEM}
# --- Nombre iteration --- #
M <- 2
u <- function(k) ifelse(k<300, 1, 1/(k-299) )
#---
para <- list( sigma2 = 2,
              mu = rep(0, F.),
              omega2 = rep(1, F.) )

phigivenY <- 1:M %>% lapply(function(i) matrix(rnorm(F.*G, 2,1), ncol = F.) )
#---
sim <- function(niter, Phih, phigivenY)
{
  M <- length(phigivenY)

  phigivenY <- 1:M %>% lapply( function(i)
    MH_High_Dim(niter, phigivenY[[i]], transi.phi, loglik.phi, Phih ))

  list(phi = phigivenY)
}

maxi <- function(S)
{
  mu <- S[attr(S,'3')]/G # = S[4]
  return(list(sigma2 = S[attr(S,'1')]/n,
              mu = mu,
              omega2 = S[attr(S,'2')]/G - mu^2)
  )
}
maxi(S(attr(dt, 'phi')))

#para <- param + U

niter <- 100
Z <- list(phi = phigivenY)
res <- SAEM(niter, 10, u, para, Phi, S, Z, sim, maxi, eps = 5e-1, verbatim = F)
plot(res)
plot(res$Z$phi[[1]], dim = G)


```










